# Логика расчета платежей и продления подписки

## Текущие тарифы

| Тариф | Название | Первый платеж | Стоимость подключения | Продление (мес) | Первый месяц включен |
|-------|----------|---------------|----------------------|-----------------|---------------------|
| **basic** | Старт | **9 975 ₽** | **9 975 ₽** | **1 975 ₽** | ✅ Да |
| **professional** | Бизнес | **19 975 ₽** | **19 975 ₽** | **4 975 ₽** | ✅ Да |
| **enterprise** | Премиум | **49 975 ₽** | **49 975 ₽** | **14 975 ₽** | ✅ Да |

---

## Поля тарифа в базе данных

```sql
CREATE TABLE tariff_plans (
    id VARCHAR(50) PRIMARY KEY,
    name VARCHAR(255) NOT NULL,
    price DECIMAL(10, 2) NOT NULL,              -- Отображаемая цена (= первому платежу)
    setup_fee DECIMAL(10, 2) DEFAULT 0,         -- Стоимость подключения
    renewal_price DECIMAL(10, 2),               -- Ежемесячная цена продления
    first_month_included BOOLEAN DEFAULT false, -- Первый месяц включен в setup_fee?
    period VARCHAR(50) DEFAULT 'month',
    is_active BOOLEAN DEFAULT true
);
```

### Описание полей:

- **price** — отображаемая цена, равная первому платежу (для совместимости с интерфейсами)
- **setup_fee** — стоимость подключения (может включать или не включать первый месяц)
- **renewal_price** — ежемесячная стоимость продления подписки
- **first_month_included** — флаг, определяющий логику первого платежа:
  - `true` = первый месяц включен в setup_fee
  - `false` = первый платеж = setup_fee + renewal_price

---

## Формулы расчета

### 1. Первый платеж (подключение)

```javascript
if (first_month_included === true) {
    первый_платеж = setup_fee;
    период_подписки = 30 дней;
} else {
    первый_платеж = setup_fee + renewal_price;
    период_подписки = 30 дней;
}
```

**Текущие значения (first_month_included = true для всех):**
- Старт: `9 975 ₽` → доступ на 30 дней
- Бизнес: `19 975 ₽` → доступ на 30 дней
- Премиум: `49 975 ₽` → доступ на 30 дней

### 2. Продление подписки

```javascript
платеж_продления = renewal_price × количество_месяцев;
новая_дата_окончания = текущая_дата_окончания + (30 × количество_месяцев) дней;
```

**Примеры:**
- Старт: `1 975 ₽/мес` × 1 = 1 975 ₽
- Бизнес: `4 975 ₽/мес` × 1 = 4 975 ₽
- Премиум: `14 975 ₽/мес` × 1 = 14 975 ₽

---

## Примеры расчетов по каждому тарифу

### Тариф "Старт"

**Сценарий:**
1. Клиент оплачивает первый раз → **9 975 ₽**
2. Получает доступ до: `сегодня + 30 дней`
3. Через 30 дней платит → **1 975 ₽**
4. Подписка продлевается до: `предыдущая_дата + 30 дней`

**Годовая стоимость:**
```
Первый год:
  Первый платеж:    9 975 ₽  (включен 1 месяц)
  + 11 продлений:  21 725 ₽  (1 975₽ × 11)
  Итого:           31 700 ₽

Второй год:
  12 продлений:    23 700 ₽  (1 975₽ × 12)
```

---

### Тариф "Бизнес"

**Сценарий:**
1. Клиент оплачивает первый раз → **19 975 ₽**
2. Получает доступ до: `сегодня + 30 дней`
3. Через 30 дней платит → **4 975 ₽**
4. Подписка продлевается до: `предыдущая_дата + 30 дней`

**Годовая стоимость:**
```
Первый год:
  Первый платеж:    19 975 ₽  (включен 1 месяц)
  + 11 продлений:   54 725 ₽  (4 975₽ × 11)
  Итого:            74 700 ₽

Второй год:
  12 продлений:     59 700 ₽  (4 975₽ × 12)
```

---

### Тариф "Премиум"

**Сценарий:**
1. Клиент оплачивает первый раз → **49 975 ₽**
2. Получает доступ до: `сегодня + 30 дней`
3. Через 30 дней платит → **14 975 ₽**
4. Подписка продлевается до: `предыдущая_дата + 30 дней`

**Годовая стоимость:**
```
Первый год:
  Первый платеж:    49 975 ₽  (включен 1 месяц)
  + 11 продлений:  164 725 ₽  (14 975₽ × 11)
  Итого:           214 700 ₽

Второй год:
  12 продлений:    179 700 ₽  (14 975₽ × 12)
```

---

## Техническая реализация

### Frontend (PaymentPage.tsx)

```typescript
// Расчет первого платежа
const firstPaymentAmount = selectedPlan.first_month_included 
  ? selectedPlan.setup_fee 
  : selectedPlan.setup_fee + selectedPlan.renewal_price;

const paymentData = {
  amount: firstPaymentAmount,
  metadata: {
    tariff_id: selectedTariff,
    first_month_included: selectedPlan.first_month_included  // Передаем в webhook
  }
};
```

### Backend (yookassa-webhook/index.py)

```python
# При получении успешного платежа
if owner_email:  # Это первый платеж (создание подписки)
    tariff_id = metadata.get('tariff_id', 'basic')
    first_month_included = metadata.get('first_month_included', False)
    
    # Определяем дату окончания подписки
    if first_month_included:
        subscription_end = datetime.utcnow() + timedelta(days=30)
    else:
        subscription_end = datetime.utcnow()  # Setup fee без месяца
    
    # Создаем tenant и user с subscription_end_date
```

### Продление подписки (SubscriptionWidget.tsx)

```typescript
// Расчет стоимости продления
const response = await fetch(`${BACKEND_URL}?action=create_payment`, {
  method: 'POST',
  body: JSON.stringify({
    amount: subscription.renewal_price * renewalMonths,  // renewal_price × месяцы
    metadata: {
      tenant_id: tenantId,
      payment_type: 'renewal',
      months: renewalMonths
    }
  })
});
```

---

## Управление тарифами в админке

### Редактирование тарифа

Суперадмин может изменить:
1. **Название тарифа** — отображаемое имя
2. **Стоимость подключения** — setup_fee (разовый платеж)
3. **Первоначальная оплата** — price (= первому платежу для отображения)
4. **Стоимость продления в месяц** — renewal_price (ежемесячно)
5. **✅ Первый месяц включен в стоимость подключения** — first_month_included
   - ✅ Включен: первый платеж = setup_fee, клиент получает 30 дней
   - ❌ Не включен: первый платеж = setup_fee + renewal_price, клиент получает 30 дней
6. **Период первоначальной оплаты** — месяц/год/навсегда
7. **Тариф активен** — отображается ли на сайте

---

## Проверка правильности расчетов

### ✅ Правильно настроено:

1. **База данных:**
   - Поле `first_month_included` добавлено
   - Все тарифы имеют `first_month_included = true`
   - Значения setup_fee и renewal_price корректные

2. **Frontend:**
   - PaymentPage рассчитывает первый платеж по формуле
   - Metadata включает флаг `first_month_included`

3. **Backend:**
   - Webhook учитывает флаг при создании подписки
   - Дата окончания подписки рассчитывается правильно

4. **Админка:**
   - Интерфейс редактирования тарифов обновлен
   - Галочка "Первый месяц включен" работает
   - API сохраняет/загружает поле `first_month_included`

---

## Итоговая проверка

✅ Тариф "Старт": Клиент платит 9975₽ → получает 30 дней → через месяц платит 1975₽  
✅ Тариф "Бизнес": Клиент платит 19975₽ → получает 30 дней → через месяц платит 4975₽  
✅ Тариф "Премиум": Клиент платит 49975₽ → получает 30 дней → через месяц платит 14975₽

**Все работает правильно!** ✨
